---
title: "Semseterprojekt Wildschweinschreck"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "Bettina Putzi"
---


```{r libraries, echo=F, results='hide', message=F, warning=F}

library(readr)        # to import tabular data (e.g. csv)
library(dplyr)        # to manipulate (tabular) data
library(ggplot2)      # to visualize data
library(sf)           # to handle spatial vector data
library(terra)        # To handle raster data
library(lubridate)    # To handle dates and times
library(zoo)
#install.packages("devtools")
library(devtools)
library(ComputationalMovementAnalysisData)

library(forcats)
library(plotly)
library(tidyr) # to reshape tables
library(tmap)     # Background maps
library(cowplot) # plots nebeneinander aufzeigen
```



```{r Daten einlesen, echo=F, results='hide', message=F, warning=F}
#devtools::install_github("ComputationalMovementAnalysis/ComputationalMovementAnalysisData")
head(wildschwein_BE)
wildschwein_BE<-wildschwein_BE
wildschwein_metadata<-wildschwein_metadata
wildschwein_overlap_temp<-wildschwein_overlap_temp
schreck_agenda<-schreck_agenda
schreck_locations<-schreck_locations
```


## Übersicht und Dataset-Reduktion
```{r Nils Code on sampling regime, include=F, eval=T}
limits <- c(0,200)
breaks = seq(0,200,50)
labels = paste(c(rep("",length(breaks)-1),">"), breaks)

wildschwein_BE<-wildschwein_BE %>%
  mutate(TierName = fct_reorder(TierName, DatetimeUTC,min, .desc = TRUE)) %>%
  group_by(TierID, TierName, CollarID) %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC, units = "mins")),
    )


```

#### 1. Übersicht der getrackten 19 Wildschweine im Originaldatensatz für die Definition des maximal zu untersuchenden Zeitintervalls
Minimum-Datum: 2014-05-28, Maximum-Datum: 2016-10-18
```{r Plot_sampling_regime, echo=F, results='hide', message=F, warning=F}
ggplot(wildschwein_BE,aes(DatetimeUTC, TierName, colour = timelag)) +
  geom_line(lwd = 10) +
  scale_color_gradientn(name = "Sampling interval", colours = RColorBrewer::brewer.pal(11, "Spectral"), limits = limits, na.value = NA, oob = scales::squish, breaks = seq(0,200,50), labels = labels) +
  theme_minimal() +
  theme(legend.position = "top") +
  guides(color = guide_colorbar(title.position = "top", title.hjust = .5, barwidth = unit(20, "lines"), barheight = unit(.5, "lines")))
```


#### 2. Geografische Zusammenhänge zwischen den Wildschweinen und den Wildschweinschrecks:
Visualisierung der Aufenthaltsgebiete mit allen vorhandenen Positionspunkte pro Individuum, um die maximale räumliche Ausdehnung darstellen zu können.

```{r spatial_overlaps, echo=F, results='hide', message=F, warning=F}
# Ortsbezogne Wildschweindaten werden  CRS 2056 zugewiesen
wildschwein_sf <- wildschwein_BE %>%
  st_as_sf(coords = c("E", "N"), crs = 2056) %>%
  mutate(tiercollar = paste(TierID, TierName, CollarID))
wildschwein_sf

# Die ortsbezogenen Wilschweinschreck-Daten werden dem CRS 4326 zugewiesen und zu 2056 umgewandelt
WSS_sf <- schreck_locations%>%
  st_as_sf(coords = c("lon","lat"), crs=4326, remove = FALSE) 

WSS_sf <- st_transform(WSS_sf, 2056)
WSS_sf
str(WSS_sf)

# wir möchten die Koordinaten in Einzelspalten. Mit folgendem Code erhalten wir x und y (für lat und lon)
WSS_sf <- WSS_sf %>%
  cbind(., st_coordinates(WSS_sf))


# Ein Convex-Hull wird erstellt und geplottet, um die Verteilung der Wildschweine aufzuzeigen
wildschwein_convex_hull <- wildschwein_sf %>%
  group_by(TierID, TierName, CollarID) %>%
  summarise() %>%
  st_convex_hull()

# wildschwein_convex_hull %>%
#   mutate(tiercollar = paste(TierID, TierName, CollarID))%>%
#   ggplot(aes(fill = factor(TierID))) + geom_sf(alpha = 0.1) +
#   coord_sf(datum = 2056) +
#   facet_wrap(~tiercollar) +
#   theme(legend.position = "none")

wildschwein_convex_hull %>%
  mutate(tiercollar = paste(TierID, TierName, CollarID))

# Zusätzlich wird der Zusammenhang der Wildschweine und der Wildschweinschrecks aufgezeigt
plot_boars_schreck<-ggplot()+
 geom_sf(data = wildschwein_convex_hull, aes(fill = factor(TierID), alpha=0.1))+
 geom_sf(data = WSS_sf, aes(color=factor(id)))+
  coord_sf(datum = 2056)+
  theme(legend.position = "none")

plot_boars_schreck
```


Wildschweinschrecks herausfiltern, die nicht in den Convex-Hulls der Wildschweine sind, d.h. in deren Nähe sich die Wildschweine nicht aufgehalten haben --> explorativ gemäss dem Plot, indem die Koordinaten eingegrenzt werden (X <= 2580000 & X>2560000 & Y <= 1210000   & Y > 119000). Feststellung: Viele Schrecks liegen ausserhalb des Aufenthaltsgebietes der Wildschweine.
```{r relevant_spatial_overlaps, echo=F, results='hide', message=F, warning=F}
# jetzt können alle Wildschweinschrecks rausgefiltert werden, die nicht in den convex hulls sind. Viele der Wildschweinschrecks sind ausserhalb des Aufenthaltsgebiets von Wildschweinen. Wir machen das explorativ, d.h. wir grenzen die Koordinaten gemäss dem Plot ein.
WSS_sf_relevant <- WSS_sf%>%
  filter(X <= 2580000 & X>2560000 & Y <= 1210000   & Y > 119000) # Alle Wildschwienschrecks im näheren Umkreis der Wildschwein-Aufethaltsgebiete sind in WSS_sf_relevant gespiechert
	
# hier nochmal der Plot, nur noch mit den relevanten Wildschweinschrecks
plot_boars_schreck_rel<-ggplot()+
 geom_sf(data = wildschwein_convex_hull, aes(fill = factor(TierID), alpha=0.1))+
 geom_sf(data = WSS_sf_relevant, aes(color=factor(id)))+
  coord_sf(datum = 2056)+
  theme(legend.position = "none")

plot_boars_schreck_rel
```



####	3. Zeitlich und geografisch relevante Wildschweinschrecks in Abhängigkeit von den Wildschweindaten
Alle Daten der Schrecks löschen, die sich nicht mit den zeitlichen Wildschweindaten überschneiden, bzw. die vor und nach dem Tracking der Wildschweine laufen (Aus Task 1)

```{r  spatio-temporal-relevant-schrecks, echo=F, results='hide', message=F, warning=F}

# alle Daten die sich nicht mit den Wilschweinen überschneiden löschen
summary(wildschwein_BE$DatetimeUTC)
schreck_agenda_relevant <- schreck_agenda%>%
  filter(datum_on > "2014-05-28" & datum_on < "2016-10-18") # somit sind alle Schrecks rausgefiltert, die vor der Messung der Wildschweine schon einen Alarmton von sich geben und alle Schrecks die nach der Periode der Wildschweinmessung noch einen Ton von sich geben. Denn basierend darauf können wir keine Analysen machen. 

# alle Wildschweinschrecks die ausserhalb des Wildschweingebiets sind und die nicht der richtigen Zeitperiode entsprechen, wurden gelöscht.Es entsteht der finale Datensatz für die Wildschweinschrecks, mit dem wir arbeiten wollen (schreck_agenda_relevant)
# MIT DIESEM DATENSATZ ARBEITEN WIR FÜR DIE WILDSCHWEINSCHRECKANALYSE
schreck_agenda_relevant <- left_join(WSS_sf_relevant,schreck_agenda_relevant,by="id")
schreck_agenda_relevant <- schreck_agenda_relevant %>%
  na.omit(datum_on)

schreck_agenda_relevant$modus<-as.factor(schreck_agenda_relevant$modus)

ggplot(schreck_agenda_relevant, aes(xmin = datum_on, xmax = datum_off, y=factor(id)))+
         geom_errorbarh(aes(color = modus))

# udn ein kurzer Blick in alle Schreck-Daten:
# ggplot(schreck_agenda, aes(xmin = datum_on, xmax = datum_off, y=factor(id)))+
#          geom_errorbarh(aes(color = modus))
```


#### 4. Wildschweine, deren Zeitintervalle sich mit denjenigen der relevanten Wildschweinschrecks überlappen
Wildschweine herausfiltern mit Trackingdaten vor, im Verlauf und nach der Schreck-Laufdauer.

```{r welche wildschweine werden zeitgleich mit dem Wildschweinschreck-Alarm gemessen, echo=F, results='hide', message=F, warning=F}

# Nachfolgend werden die Samplingperioden mit den Werten mix und max pro Tier und Halsband identifiziert
sampling_periods <- wildschwein_BE %>%
  group_by(TierID, TierName, CollarID) %>%
  summarise(
    min = min(DatetimeUTC),
    max = max(DatetimeUTC)
  )

# es muss ein Intervall gebildet werden, damit nachfolgend herausgefunden werden kann, ob die Wildschweinschrecks innerhalb einer Wildschwein-Messperiode eingestellt waren (d.h. Ein- UND Ausschaltung während der Messperiode der Schweine stattfindet (idealfall). Würde dieser Idealfall nicht eintreten, könne man evtl. auch andere mögliche Schweine bestimmen.  
intervall_wildschwein <- sampling_periods$min %--% sampling_periods$max #1) Intervallbildung

sampling_periods$WSS_on_within_WS_intervalls<-schreck_agenda_relevant$datum_on %within% intervall_wildschwein #ist die Einschaltung innterhalb der Messperiode der Wildschweine?
sampling_periods$WSS_off_within_WS_intervalls<-schreck_agenda_relevant$datum_off %within% intervall_wildschwein # ist die Ausschaltung innterhalb der Messperiode der Wildschweine?

# Jetzt werden alle Schweine herausgefiltert, die vor der Einschaltung, während der Messperiode und nach der Ausschaltung der noch in Frage kommenden Wildschweinschrecks gemessen werden. d.h. alle die die Ein- und Ausschaltung überdauern. 
sampling_periods_relevant <- sampling_periods %>%
  filter(WSS_on_within_WS_intervalls==TRUE & WSS_off_within_WS_intervalls==TRUE) %>%
  mutate(tiercollar = paste(TierID, TierName, CollarID))

# es verbleiben 5 relevante Wildschweine in sampling_periods_relevant. Diese Wildschweine werden nun im Detaildatensatz der Wildschweine, mit allen relevanten Daten, herausgefiltert.

#MIT DIESEM DATENSATZ ARBEITEN WIR FÜR DIE WILDSCHWEINANALYSE
wildschwein_sf_relevant <- wildschwein_sf %>%
  filter(tiercollar == "2 Sabine 12275" | tiercollar == "36 Olga 13976" | tiercollar == "40 Franz 12273" | tiercollar == "60 Venus 13969" | tiercollar == "84 Gaby 12274" )

# Es muss wiederum ein Convexhull erstellt werden, für den gefilterten Wildschwiendatensatz
sampling_periods_relevant_convexhull <- wildschwein_sf_relevant %>%
  group_by(TierID, TierName, CollarID, tiercollar) %>%
  summarise() %>%
  st_convex_hull()


# Zuletzt wird nochmal der gleiche Plot wie anfangs erstellt, einfach nur noch mit den relevanten Wildschweinschrecks und den relevanten Wildschweinen.
plot_boars_schreck_rel_spattemp<-ggplot()+
 geom_sf(data = sampling_periods_relevant_convexhull, aes(fill = factor(tiercollar)),alpha=0.1)+
 geom_sf(data = schreck_agenda_relevant, aes(color=factor(id)))+
  coord_sf(datum = 2056)


plot_boars_schreck_rel_spattemp
```

#### Zwischenschritt: Farbcodes zu den Wildschweinen zuordnen
```{r Farbcodes zu den Wildschweinen zuordnen, echo=F, results='hide', message=F, warning=F}
# Hierzu verwenden wir Colorbrewer 2.0 https://colorbrewer2.org/#type=diverging&scheme=RdYlBu&n=5
Farbset<-c("2 Sabine 12275" = "#d7191c",
           "36 Olga 13976" = "#fdae61",
           "40 Franz 12273" = "#ffffbf",
           "60 Venus 13969" = "#abd9e9",
           "84 Gaby 12274" = "#2c7bb6")
Farbset

# der Plot mit allen relevanten SChweinen und allen relevanten WSS wird nochmal geplottet
plot_boars_schreck_rel_spattemp<-ggplot()+
 geom_sf(data = sampling_periods_relevant_convexhull, aes(fill = factor(tiercollar)),alpha=0.5)+
 geom_sf(data = schreck_agenda_relevant)+ # man könnte auch Farben den Wildschweinschrecks zuordnern, mit dem Zusatz aes(color=factor(id)))
  coord_sf(datum = 2056)+
  scale_fill_manual(values=Farbset)+
  scale_color_brewer(type = "qual")


plot_boars_schreck_rel_spattemp

```

#### 5. Die Überlappungen der Wildschweine mit den einzelnen Wildschweinschrecks
Da das Wildschweinverhalten vor und nach der Testphase der Wildschweinschrecks untersucht werden soll, muss untersucht werden, welche Wildschwein-Messungen sich mit welchem Wildschweinschreck-Testphasen überlappen und wie viel. 

```{r overlaps, echo=F, results='hide', message=F, warning=F}
# Timelag bestimmen für jeden Wildschweinschreck, um zu schauen, wie lange diese jeweils angemacht sind.
schreck_agenda_relevant <- schreck_agenda_relevant %>%
  mutate(timelag_days = as.numeric(difftime(datum_off, datum_on, unit = "days")))
schreck_agenda_relevant
# Die Kleinste Zeitperiode ist 5 Tage, was höchst wahrscheinlich nicht genügend Zeit ist für ein Wildschwein um sich daran zu gewöhnen. Dies wird höchstens am Ende noch untersucht, sofern sich herausstellt, dass sie sich so schnell daran gewöhnen. 

# Timelag bestimmenf für jedes Wildschwein, um zu sehen wie lange sie jeweils gemessen werden
wildschwein_relevant_timelags <- wildschwein_sf_relevant %>%
  group_by(tiercollar)%>%
  summarise(teimlag_days = as.numeric(difftime(max(DatetimeUTC),min(DatetimeUTC))))

# oder dasselbe nochmal mit sampling periods
sampling_periods_relevant <- sampling_periods_relevant %>%
  mutate(timelag_days = as.numeric(difftime(max,min,unit="days")))
sampling_periods_relevant
# Gaby wird mit 55 Tagen am wenigsten lang gemessen. 

ggplot()+
  geom_errorbarh(data = sampling_periods_relevant, aes(xmin=min, xmax=max, y=factor(tiercollar)),color="blue")+
  geom_errorbarh(data = schreck_agenda_relevant, aes(xmin=datum_on, xmax=datum_off, y=factor(id)),color="green")+
  scale_x_datetime(date_breaks = "1 month")+  
  theme(axis.text.x = element_text(size = 10, angle=90, hjust=1))+
  ylab("Wildschweine (blau) und Wildschweinschrecks (grün)")
# Gaby wäre für WSS_2016_13 geeignet, wobei dieser Wildschweinschreck mit 5 Tagen sehr kurz in Betrieb ist
# Sabine, Olga und Franz eignen sich alle drei für die drei Wildschweinschrecks "WSS_2015_01", "WSS_2015_03" und "WSS_2015_04"
# Venus ist für die Analyse von WSS_2016_01, WSS_2016_05 und WSS_2016_06 geeignet,

# Basierend darauf entscheiden wir, die Betrachtung von delta T1 bis delta T4 jeweils für eine Woche zu wählen.

```

Als Zwischenfazit nach der Explorativen Analyse konnte folgendes herausgefunden werden:
    - Gaby wäre für WSS_2016_13 geeignet, wobei dieser Wildschweinschreck mit 5 Tagen sehr kurz in Betrieb ist (wird voraussichtlich ausgeschlossen)
    -	Sabine, Olga und Franz eignen sich alle drei für die drei Wildschweinschrecks "WSS_2015_01", "WSS_2015_03" und "WSS_2015_04"
    -	Venus ist für die Analyse von «WSS_2016_01», «WSS_2016_05» und «WSS_2016_06» geeignet
    -	Die initial grossen Datensätze mit vielen irrelevanten Schweinen und Wildschweinschrecks konnten stark reduziert werden. 
    -	Die Zeitperioden der verbleibenden Wildschweine überlappen diejenigen der Wildschweinschrecks vor und nach der Testphase .


## Forschungsfrage 1 
> Wie kann der Effekt-Range der Wildschwein-Schrecks von den räumlichen Laufbahnen der Wildschweine hergeleitet werden? 

Eine Studie der ZHAW erklärt folgendes: "Die Wahrscheinlichkeit, dass der nächtliche Immissionsgrenzwert von 55 dB(A) durch die Geräusche des Wildschweinschrecks bei Einstellung der maximalen Lautstärke überschritten wird, liegt bei den Distanzen von 2m, 10m und 50m bei 100%. Bei 100m und 200m liegt diese Wahrscheinlichkeit immer noch bei über 90%, hingegen bei 500m nur noch bei 20%. Bei 1000m Distanz liegt die Wahrscheinlichkeit der Überschreitung der gesetzlichen Immissionsgrenzwerte bei 0% und ab 1500m sind keine Geräusche mehr messbar (Krähenmann 2015).» (Suter et al., 2018, 23f.). Entsprechend wird hier angenommen, dass mindestens bei 200 Meter doch noch einen Einfluss vermutbar wäre. 

Als datenbasierte mögliche Messgrösse könnte Beispielsweise der Abstand zum Schreck, nach Ertönen des Signaltons analysiert werden (z.B. 1h nach nach dem Schreck). Dazu muss aber zuerst analysiert werden, welche Wildschweine sich denn in der nähe welches Schrecks aufhalten. Dazu wird die Minimaldistanz zu den in der Explorativen Analyse definierten relevanten Schrecks und Wildschweinen analysiert.

Die folgende Tabelle stellt die Minimaldistanzen zum Wildschwienschreck pro Wildschwein dar. Unter der vorher getroffenen Annahme von 200 Meter Einflussbereich, würde mindestens Sabine von drei Wildschwieinschrecks beeinflusst werden, sowie Olga von einem. 

```{r minimal distance, include=F}
#wieder Wildschwein_sf_relevant und schreck_agenda_relevant arbeiten. Wie bringen wir die zwei Tabellen zusammen?

# Daten studieren:
wildschwein_sf_relevant
# hier fehlt noch das auseinandernehmen der geometries
wildschwein_sf_relevant <- wildschwein_sf_relevant %>%
  cbind(., st_coordinates(wildschwein_sf_relevant))

schreck_agenda_relevant_short <- select(schreck_agenda_relevant, id, X, Y)


###### Trial and Error ;)
# WSS_id=c("WSS_2015_01","WSS_2015_03","WSS_2015_04", "WSS_2016_01","WSS_2016_05","WSS_2016_06")
# WSS_X=c(WSS_2015_01$X,WSS_2015_03$X,WSS_2015_04$X, WSS_2016_01$X,WSS_2016_05$X,WSS_2016_06$X)
# WSS_Y=c(WSS_2015_01$Y,WSS_2015_03$Y,WSS_2015_04$Y, WSS_2016_01$Y,WSS_2016_05$Y,WSS_2016_06$Y)
# cbind(WSS_id,WSS_X,WSS_Y)
# 
# library(purrr)
# 
# 
# WSS_list_id_X <- map(WSS_id, function(X){
#   X_WSS_id<-rep(WSS_id$X, times=84915)
# 
# })
####### End of Trial and Error

## Die 6 verbleibenden Wildschweinschrecks werden dem Datensatz der Wildschweine hinzugefügt

WSS_2016_01<-subset(schreck_agenda_relevant_short, id=="WSS_2016_01")
str(wildschwein_sf_relevant) # 84915 observations



WSS_2016_05<-subset(schreck_agenda_relevant_short, id=="WSS_2016_05")


WSS_2016_06<-subset(schreck_agenda_relevant_short, id=="WSS_2016_06")


WSS_2015_01<-subset(schreck_agenda_relevant_short, id=="WSS_2015_01")
WSS_2015_01<-unique(WSS_2015_01)
str(wildschwein_sf_relevant) # 84915 observations

WSS_2015_03<-subset(schreck_agenda_relevant_short, id=="WSS_2015_03")
WSS_2015_03<-unique(WSS_2015_03)

WSS_2015_04<-subset(schreck_agenda_relevant_short, id=="WSS_2015_04")
WSS_2015_04<-unique(WSS_2015_04)

# Die Euklidischen Distanzen zum Schreck werden berechnet um herauszufinden, ob die Schweine potenziell vom Wildschweinschreck beeinflusst werden könnten
# zuerst für Venus

Venus <- wildschwein_sf_relevant%>%
  subset(TierName=="Venus")%>%
  mutate(distance_2016_01 = sqrt((X-as.numeric(WSS_2016_01$X))^2+(Y-as.numeric(WSS_2016_01$Y))^2))%>%
  mutate(distance_2016_05 = sqrt((X-as.numeric(WSS_2016_05$X))^2+(Y-as.numeric(WSS_2016_05$Y))^2))%>%
  mutate(distance_2016_06 = sqrt((X-as.numeric(WSS_2016_06$X))^2+(Y-as.numeric(WSS_2016_06$Y))^2))
min(Venus$distance_2016_01) ## die Minimaldistanz ist 2781 Meter, das heisst, dass Venus wohl nicht von diesem Schreck beeinflusst wird.
min(Venus$distance_2016_05) ## die Minimaldistanz ist 4612 Meter, das heisst, dass Venus wohl nicht von diesem Schreck beeinflusst wird.
min(Venus$distance_2016_06) ## die Minimaldistanz ist 448 Meter, das heisst, dass Venus wohl kaum von diesem Schreck beeinflusst wird.

# Sabine
Sabine <- wildschwein_sf_relevant%>%
  subset(TierName=="Sabine")%>%
  mutate(distance_2015_01 = sqrt((X-as.numeric(WSS_2015_01$X))^2+(Y-as.numeric(WSS_2015_01$Y))^2))%>%
  mutate(distance_2015_03 = sqrt((X-as.numeric(WSS_2015_03$X))^2+(Y-as.numeric(WSS_2015_03$Y))^2))%>%
  mutate(distance_2015_04 = sqrt((X-as.numeric(WSS_2015_04$X))^2+(Y-as.numeric(WSS_2015_04$Y))^2))
min(Sabine$distance_2015_01) ## die Minimaldistanz ist 10 Meter, das heisst, dass Sabine von diesem Schreck beeinflusst werden könnte.
min(Sabine$distance_2015_03) ## die Minimaldistanz ist 25 Meter, das heisst, dass Sabine von diesem Schreck beeinflusst werden könnte.
min(Sabine$distance_2015_04) ## die Minimaldistanz ist 42 Meter, das heisst, dass Sabine von diesem Schreck beeinflusst werden könnte.

# Olga
Olga <- wildschwein_sf_relevant%>%
  subset(TierName=="Olga")%>%
  mutate(distance_2015_01 = sqrt((X-as.numeric(WSS_2015_01$X))^2+(Y-as.numeric(WSS_2015_01$Y))^2))%>%
  mutate(distance_2015_03 = sqrt((X-as.numeric(WSS_2015_03$X))^2+(Y-as.numeric(WSS_2015_03$Y))^2))%>%
  mutate(distance_2015_04 = sqrt((X-as.numeric(WSS_2015_04$X))^2+(Y-as.numeric(WSS_2015_04$Y))^2))
min(Olga$distance_2015_01) ## die Minimaldistanz ist 8 Meter, das heisst, dass Olga von diesem Schreck beeinflusst werden könnte.
min(Olga$distance_2015_03) ## die Minimaldistanz ist 704 Meter, das heisst, dass Olga wohl nicht von diesem Schreck beeinflusst wird.
min(Olga$distance_2015_04) ## die Minimaldistanz ist 401 Meter, das heisst, dass Olga wohl kaum von diesem Schreck beeinflusst wird.

# Franz
Franz <- wildschwein_sf_relevant%>%
  subset(TierName=="Franz")%>%
  mutate(distance_2015_01 = sqrt((X-as.numeric(WSS_2015_01$X))^2+(Y-as.numeric(WSS_2015_01$Y))^2))%>%
  mutate(distance_2015_03 = sqrt((X-as.numeric(WSS_2015_03$X))^2+(Y-as.numeric(WSS_2015_03$Y))^2))%>%
  mutate(distance_2015_04 = sqrt((X-as.numeric(WSS_2015_04$X))^2+(Y-as.numeric(WSS_2015_04$Y))^2))
min(Franz$distance_2015_01) ## die Minimaldistanz ist 8 Meter, das heisst, dass Franz von diesem Schreck beeinflusst werden könnte.
min(Franz$distance_2015_03) ## die Minimaldistanz ist 704 Meter, das heisst, dass Franz wohl nicht von diesem Schreck beeinflusst
min(Franz$distance_2015_04) ## die Minimaldistanz ist 401 Meter, das heisst, dass Franz wohl kaum von diesem Schreck beeinflusst wird.



Mind_dist_table <-data.frame(WSS=c("2015_01","2015_03","2015_04", "2016_01","2016_05","2016_06"),
                Franz=c((min(Franz$distance_2015_01)),min(Franz$distance_2015_03),min(Franz$distance_2015_04), "NA", "NA", "NA"),
                Sabine=c((min(Sabine$distance_2015_01)),min(Sabine$distance_2015_03),min(Sabine$distance_2015_04),"NA", "NA", "NA"),
                Olga=c((min(Olga$distance_2015_01)),min(Olga$distance_2015_03),min(Olga$distance_2015_04),"NA", "NA", "NA"),
                Venus=c("NA", "NA", "NA", min(Venus$distance_2016_01) , min(Venus$distance_2016_05), min(Venus$distance_2016_06))
                )
                


```

```{r Table_Mindist, echo=F, message=F, warning=F }
knitr::kable(Mind_dist_table,capiton="Minimaldistanzen zwischen den Wildschwienschrecks und den Wildschweinen")
```


Sabine und Olga werden entsprechend näher untersucht. Dazu werden erst einmal die Wege der Schweine zwei Tage vor ertönen des ersten Schrecks und zwei Tage nach Ertönen des ersten Schrecks abgebildet: 

```{r Research Question 1, echo=F, results='hide', message=F, warning=F }
# ich möchte Sabine nun genauer untersuchen

Sabine <- Sabine %>%
  mutate(steplength = sqrt((X-lead(X))^2+(Y-lead(Y))^2), # in meters
         timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "secs")), # in seconds
         speed = steplength/timelag) # in meters per second


# es werden drei Zeitpunkte festgelegt, um 2 Zeitintervalle zu untersuchen. dies sind der Zeitpunkt eine Woche vor dem Schreck, der Zeitpunkt am Datum_on des Schrecks, und der Zeitpunkt 1 Woche nach Einschalten des Schrecks. die Zeitspannen daziwschen sind zu untersuchen:
schreck_agenda_2015_04 <- filter(schreck_agenda_relevant,id=="WSS_2015_04")
t2_WSS_2015_04 <- min(schreck_agenda_2015_04$datum_on)
t2_WSS_2015_04 <- t2_WSS_2015_04-minutes(150) # ich nehme an, dass es um 21:30 dämmert
t1_WSS_2015_04_5h <- t2_WSS_2015_04-hours(5)
t3_WSS_2015_04_5h <- t2_WSS_2015_04+hours(5)
t1_WSS_2015_04_2d <- t2_WSS_2015_04-days(2)
t3_WSS_2015_04_2d <- t2_WSS_2015_04+days(2)

Sabine_t1_t2_04_5h <- Sabine%>%
  filter(DatetimeUTC > t1_WSS_2015_04_5h & DatetimeUTC <= t2_WSS_2015_04 )
Sabine_t1_t2_04_2d <- Sabine%>%
  filter(DatetimeUTC > t1_WSS_2015_04_2d & DatetimeUTC <= t2_WSS_2015_04 )

Sabine_t2_t3_04_5h <- Sabine%>%
  filter(DatetimeUTC >= t2_WSS_2015_04 & DatetimeUTC < t3_WSS_2015_04_5h )
Sabine_t2_t3_04_2d <- Sabine%>%
  filter(DatetimeUTC >= t2_WSS_2015_04 & DatetimeUTC < t3_WSS_2015_04_2d )

plot_5h<- ggplot() +
  geom_path(data = Sabine_t1_t2_04_5h, aes(X,Y, color="5h before")) +
  geom_point(data = schreck_agenda_2015_04, aes(X,Y),color="blue",shape="triangle", size=4) +
  geom_path(data = Sabine_t2_t3_04_5h, aes(X,Y, color="5h after")) +
  #labs(color="Trajectory", title = "Der Vergleich von Sabine 5h vor und 5h nach dem ersten Ertönen des Schrecks")  +
  theme_minimal()+
  theme(legend.position="bottom")

plot_2d<-ggplot() +
  geom_path(data = Sabine_t1_t2_04_2d, aes(X,Y, color="2 days before")) +
  geom_path(data = Sabine_t2_t3_04_2d, aes(X,Y, color="2 days after")) +
  geom_point(data = schreck_agenda_2015_04, aes(X,Y),color="blue",shape="triangle", size=4) +
  #labs(color="Trajectory", title = "Der Vergleich von Sabine zwei Tage vor und zwei Tage nach dem ersten Ertönen des Schrecks")  +
  theme_minimal()+
   theme(legend.position="bottom")


plot_grid(plot_5h, plot_2d, labels="AUTO")


# Der Wildschweinschreck scheint gar keinen Einfluss auf das Verhalten von Sabine zu haben. Vielleicht ein anderer Wildschweinschreck?


# dasselbe Vorgehen einfach mit einem anderen Schreck: 
schreck_agenda_2015_01 <- filter(schreck_agenda_relevant,id=="WSS_2015_01")
t2_WSS_2015_01 <- min(schreck_agenda_2015_01$datum_on)
t2_WSS_2015_01 <- t2_WSS_2015_01-minutes(150)
t2_WSS_2015_01
t1_WSS_2015_01_5h <- t2_WSS_2015_01-hours(5)
t3_WSS_2015_01_5h <- t2_WSS_2015_01+hours(5)
t1_WSS_2015_01_2d <- t2_WSS_2015_01-days(2)
t3_WSS_2015_01_2d <- t2_WSS_2015_01+days(2)

Sabine_t1_t2_01_5h <- Sabine%>%
  filter(DatetimeUTC > t1_WSS_2015_01_5h & DatetimeUTC <= t2_WSS_2015_01 )
Sabine_t1_t2_01_2d <- Sabine%>%
  filter(DatetimeUTC > t1_WSS_2015_01_2d & DatetimeUTC <= t2_WSS_2015_01 )

Sabine_t2_t3_01_5h <- Sabine%>%
  filter(DatetimeUTC >= t2_WSS_2015_01 & DatetimeUTC < t3_WSS_2015_01_5h )
Sabine_t2_t3_01_2d <- Sabine%>%
  filter(DatetimeUTC >= t2_WSS_2015_01 & DatetimeUTC < t3_WSS_2015_01_2d )


plot_5h_01<- ggplot() +
  geom_path(data = Sabine_t1_t2_01_5h, aes(X,Y, color="5h before")) +
  geom_point(data = schreck_agenda_2015_01, aes(X,Y),color="blue",shape="triangle", size=4) +
  geom_path(data = Sabine_t2_t3_01_5h, aes(X,Y, color="5h after")) +
  #labs(color="Trajectory", title = "Der Vergleich von Sabine 5h vor und 5h nach dem ersten Ertönen des Schrecks")  +
  theme_minimal()+
  theme(legend.position="bottom")

plot_2d_01<-ggplot() +
  geom_path(data = Sabine_t1_t2_01_2d, aes(X,Y, color="2 days before")) +
  geom_path(data = Sabine_t2_t3_01_2d, aes(X,Y, color="2 days after")) +
  geom_point(data = schreck_agenda_2015_01, aes(X,Y),color="blue",shape="triangle", size=4) +
  #labs(color="Trajectory", title = "Der Vergleich von Sabine zwei Tage vor und zwei Tage nach dem ersten Ertönen des Schrecks")  +
  theme_minimal()+
   theme(legend.position="bottom")

plot_grid(plot_5h_01, plot_2d_01, labels="AUTO")
# auch hier scheint der Schreck keinen Einfluss nehmen zu können.


# deshalb wird zum schluss noch  Olga untersucht
Olga_t1_t2_01_2d <- Olga%>%
  filter(DatetimeUTC > t1_WSS_2015_01_2d & DatetimeUTC < t2_WSS_2015_01)
Olga_t1_t2_01_5h <- Olga%>%
  filter(DatetimeUTC > t1_WSS_2015_01_5h & DatetimeUTC < t2_WSS_2015_01)

Olga_t2_t3_01_2d <- Olga%>%
  filter(DatetimeUTC > t2_WSS_2015_01 & DatetimeUTC < t3_WSS_2015_01_2d )
Olga_t2_t3_01_5h <- Olga%>%
  filter(DatetimeUTC > t2_WSS_2015_01 & DatetimeUTC < t3_WSS_2015_01_5h )

plot_5h_01_olg<-ggplot() +
  geom_path(data = Olga_t1_t2_01_5h, aes(X,Y, color="5h before")) +
  geom_point(data = schreck_agenda_2015_01, aes(X,Y),color="blue",shape="triangle", size=4) +
  geom_path(data = Olga_t2_t3_01_5h, aes(X,Y, color="5h after")) +
  labs(color="Trajectory", title = "Der Vergleich von Olga vor und nach dem Schreck") +
  theme_minimal()
  
  
# auch hier ist kein Einfluss des Wildschweinschrecks auf das Wildschwein zu erkennen. Um nochmal genauer hinzuschauen, werden nur noch die Trajectories bei Nacht untersucht. dies hilft den genauen Zeitpunkt zu bestimmen, da der Wildschweinschreck bei der dämmerung losgeht

Olga_t1_t2_01_5h_nacht <- Olga_t1_t2_01_5h %>%
  filter(day != "Tag")
Olga_t1_t2_01_2d_nacht <- Olga_t1_t2_01_2d %>%
  filter(day != "Tag")
  
  
Olga_t2_t3_01_5h_nacht <- Olga_t2_t3_01_5h %>%
  filter(day != "Tag") 
Olga_t2_t3_01_2d_nacht <- Olga_t2_t3_01_2d %>%
  filter(day != "Tag") 

plot_olga_night_5h<-ggplot() +
  geom_path(data = Olga_t1_t2_01_5h_nacht, aes(X,Y, color="5h before (here no day trips included)")) +
  geom_point(data = schreck_agenda_2015_01, aes(X,Y),color="blue",shape="triangle", size=4) +
  geom_path(data = Olga_t2_t3_01_5h_nacht, aes(X,Y, color="5 h after")) +
  labs(color="Trajectory") +
  theme_minimal()+
  ylim(1204400,1205620)+
  theme(legend.position="bottom")

plot_olga_night_2d<-ggplot() +
  geom_path(data = Olga_t1_t2_01_2d_nacht, aes(X,Y, color="2 days before")) +
  geom_point(data = schreck_agenda_2015_01, aes(X,Y),color="blue",shape="triangle", size=4) +
  geom_path(data = Olga_t2_t3_01_2d_nacht, aes(X,Y, color="2 days after")) +
  labs(color="Trajectory") +
  theme_minimal()+
  ylim(1204400,1205620)+
  theme(legend.position="bottom")

plot_grid(plot_olga_night_5h, plot_olga_night_2d, labels="AUTO")


# wiederum ist kein Einfluss zu erkennen. 
  
```
Es zeigt sich bei allen Plot keinen Einfluss des Wildschweinschrecks auf das Wildschwein. Die Tiere gehen trotz Alarm teilweise sogar noch näher an den Schreck heran. Entsprechend muss der zweite Teil der Analyse, nämlich die Veränderung über die Zeit (z.B. durch Gewöhnung), nicht untersucht werden. Auch die weitere Untersuchung von Wildschweinen, die sich ebenfalls im potenziellen Einflussbereich der Wildschweinschrecks aufhalten, kann weggelassen werden. Diese hätte nur dann Sinn gemacht, wenn bei den anderen Schweinen ein sichtbarer Effekt aufgetreten wäre. 


## Forschungsfrage 2
> Wie entwickelt sich die räumlich-zeitliche Verteilung der Wildschweine vor, während und nach der Testphase mit dem Schreck? 

In der Forschungsfrage 1 konnte kein Einfluss der Wildschweinschrecks auf die Wildschweine nachgewiesen werden. Es könnte jedoch sein, dass der Einbezug von First Order Effects dieses Bild ändert. Es könnte ja sein, dass die Wildschweine beispielsweise in der Nähe des Schrecks bleiben, sie sich jedoch mehr im Wald aufhalten als davor. Dem wird mit Forschungsfrage 2 nachgegangen, indem für eins der Schweine die Aufenthaltsorte bestimmt werden. 

Als erstes werden die Aufenthaltsorte der Schweine nochmals geplottet, diesmal inkl. Informationen zu der Umgebung. 

```{r background map, echo=F, results='hide', message=F, warning=F }
crop_fanel <- read_sf("Feldaufnahmen_Fanel.gpkg")

head(crop_fanel)

summary(crop_fanel)

unique(crop_fanel$Frucht)

st_crs(crop_fanel)

ggplot() +
  geom_sf(data = crop_fanel,aes(fill = Frucht))+
  geom_sf(data = sampling_periods_relevant_convexhull, aes(color = factor(tiercollar), alpha=0.1))+
  geom_sf(data = schreck_agenda_relevant)+ # man könnte auch Farben den Wildschweinschrecks zuordnen, mit dem Zusatz aes(color=factor(id)))
  coord_sf(datum = 2056)+
  scale_color_manual(values=Farbset)


# Eine Hintergrundmap einfügen, um zu sehen, ob die Daten zur "Frucht" für die Forschungsfrage 2 ausreichen. das scheint zu passen, nur Franz hält sich auch in Gebieten auf, wo es keine Fruchdaten gibt.
  
pk100_BE <- rast("pk100_BE.tif")
tm_shape(pk100_BE) + 
  tm_rgb() +
  tm_shape(crop_fanel)+
  tm_fill(col="Frucht")+
  tm_shape(sampling_periods_relevant_convexhull)+
  tm_polygons(col="tiercollar", alpha=0.5, boarder.col="black", fill=Farbset)+
  tm_layout(legend.outside = TRUE)
```

Jetzt werden für die Aufenthaltsorte der Wildschweine mit den Umgebungsdaten verknüpft. Danach wird berechnet, zu welchem Anteil sich Sabine in welcher Umgebung aufhält. Dies wird für 2 Tage vor und zwei Tage nach dem ersten Schrecksignal untersucht. 
```{r}
wildschwein_1stO_2d_before <-  st_join(Sabine_t1_t2_01_2d, crop_fanel)
wildschwein_1stO_2d_after <- st_join(Sabine_t2_t3_01_2d, crop_fanel)

Sabine_smry_before <- wildschwein_1stO_2d_before %>%
  st_set_geometry(NULL) %>%
  mutate(
    hour = hour(round_date(DatetimeUTC,"hour")),
    Frucht = ifelse(is.na(Frucht),"other",Frucht),
    Frucht = fct_lump(Frucht, 5,other_level = "other"),
  ) %>%
  group_by(tiercollar ,hour,Frucht) %>%
  count() %>%
  ungroup() %>%
  group_by(tiercollar , hour) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    Frucht = fct_reorder(Frucht, n,sum, desc = TRUE)
  )

Sabine_smry_after <- wildschwein_1stO_2d_after %>%
  st_set_geometry(NULL) %>%
  mutate(
    hour = hour(round_date(DatetimeUTC,"hour")),
    Frucht = ifelse(is.na(Frucht),"other",Frucht),
    Frucht = fct_lump(Frucht, 5,other_level = "other"),
  ) %>%
  group_by(tiercollar ,hour,Frucht) %>%
  count() %>%
  ungroup() %>%
  group_by(tiercollar , hour) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    Frucht = fct_reorder(Frucht, n,sum, desc = TRUE)
  )

p_1stO_1_before <- ggplot(Sabine_smry_before, aes(hour,perc, fill = Frucht)) +
  geom_col(width = 1) +
  scale_y_continuous(name = "Percentage", labels = scales::percent_format()) +
  scale_x_continuous(name = "Time (rounded to the nearest hour)") +
  facet_wrap(~tiercollar ) +
  theme_light() +
  labs(title = "Percentages of samples in a given crop per hour",subtitle = "Only showing the most common categories")
p_1stO_1_before

p_1stO_1_after <- ggplot(Sabine_smry_after, aes(hour,perc, fill = Frucht)) +
  geom_col(width = 1) +
  scale_y_continuous(name = "Percentage", labels = scales::percent_format()) +
  scale_x_continuous(name = "Time (rounded to the nearest hour)") +
  facet_wrap(~tiercollar ) +
  theme_light() +
  labs(title = "Percentages of samples in a given crop per hour",subtitle = "Only showing the most common categories")
p_1stO_1_after

```
Für Sabine hat sich gezeigt, dass Sie sich sowieso im Wald aufgehalten hat und nicht auf die Felder ging. Entsprechend hat sie sich dort wohl nicht bedroht gefühlt. Es lässt sich nicht sagen, ob sie ohne den Wildschweinschreck auf das Feld gegangen wäre.

Um einen Vergleich anstellen zu können, wird Olga im selben Masse untersucht:
```{r}
Olga_1stO_2d_before <-  st_join(Olga_t1_t2_01_2d, crop_fanel)
Olga_1stO_2d_after <- st_join(Olga_t2_t3_01_2d, crop_fanel)

Olga_smry_before <- Olga_1stO_2d_before %>%
  st_set_geometry(NULL) %>%
  mutate(
    hour = hour(round_date(DatetimeUTC,"hour")),
    Frucht = ifelse(is.na(Frucht),"other",Frucht),
    Frucht = fct_lump(Frucht, 5,other_level = "other"),
  ) %>%
  group_by(tiercollar ,hour,Frucht) %>%
  count() %>%
  ungroup() %>%
  group_by(tiercollar , hour) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    Frucht = fct_reorder(Frucht, n,sum, desc = TRUE)
  )

Olga_smry_after <- Olga_1stO_2d_after %>%
  st_set_geometry(NULL) %>%
  mutate(
    hour = hour(round_date(DatetimeUTC,"hour")),
    Frucht = ifelse(is.na(Frucht),"other",Frucht),
    Frucht = fct_lump(Frucht, 5,other_level = "other"),
  ) %>%
  group_by(tiercollar ,hour,Frucht) %>%
  count() %>%
  ungroup() %>%
  group_by(tiercollar , hour) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    Frucht = fct_reorder(Frucht, n,sum, desc = TRUE)
  )

p_1stO_1_before_Olga <- ggplot(Olga_smry_before, aes(hour,perc, fill = Frucht)) +
  geom_col(width = 1) +
  scale_y_continuous(name = "Percentage", labels = scales::percent_format()) +
  scale_x_continuous(name = "Time (rounded to the nearest hour)") +
  facet_wrap(~tiercollar ) +
  theme_light() +
   theme(legend.position="bottom")
p_1stO_1_before_Olga

p_1stO_1_after_Olga <- ggplot(Olga_smry_after, aes(hour,perc, fill = Frucht)) +
  geom_col(width = 1) +
  scale_y_continuous(name = "Percentage", labels = scales::percent_format()) +
  scale_x_continuous(name = "Time (rounded to the nearest hour)") +
  facet_wrap(~tiercollar ) +
  theme_light() +
   theme(legend.position="bottom")+


p_1stO_1_after_Olga

plot_grid(p_1stO_1_before_Olga, p_1stO_1_after_Olga, labels="AUTO")
```
Olga hat sich vor dem ersten Schrecksignal auch mal in den Bohnen, der Wiese oder der Weide aufgehalten. Nachdem der Wildschweinschreck in Betrieb genommen wurde, hat sie das noch immer gemacht. Es kann nicht mit sicherheit gesagt werden, ob sie ihr Verhalten aufgrund des Schrecks geändert hätte.

```{r}
t1_WSS_2015_01_7d <- t2_WSS_2015_01-days(7)
t3_WSS_2015_01_7d <- t2_WSS_2015_01+days(7)

Sabi_Olga_t1_t2_01_7d <- wildschwein_sf_relevant%>%
  filter(DatetimeUTC > t1_WSS_2015_01_7d & DatetimeUTC <= t2_WSS_2015_01 )%>%
  filter(tiercollar=="36 Olga 13976" | tiercollar== "2 Sabine 12275")
Sabi_Olga_t1_t2_01_7d

Sabi_Olga_t2_t3_01_7d <- wildschwein_sf_relevant%>%
  filter(DatetimeUTC >= t2_WSS_2015_01 & DatetimeUTC < t3_WSS_2015_01_7d )%>%
  filter(tiercollar=="36 Olga 13976" | tiercollar== "2 Sabine 12275")

Sabi_Olga_1stO_2d_before <-  st_join(Sabi_Olga_t1_t2_01_7d, crop_fanel)
Sabi_Olga_1stO_2d_after <- st_join(Sabine_Olga_t2_t3_01_7d, crop_fanel)

Sabi_Olga_smry_before <- Sabi_Olga_1stO_2d_before %>%
  st_set_geometry(NULL) %>%
  mutate(
    hour = hour(round_date(DatetimeUTC,"hour")),
    Frucht = ifelse(is.na(Frucht),"other",Frucht),
    Frucht = fct_lump(Frucht, 5,other_level = "other"),
  ) %>%
  group_by(tiercollar ,hour,Frucht) %>%
  count() %>%
  ungroup() %>%
  group_by(tiercollar , hour) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    Frucht = fct_reorder(Frucht, n,sum, desc = TRUE)
  )

p_1stO_1_before_Sabi_Olga <- ggplot(Sabi_Olga_smry_before, aes(hour,perc, fill = Frucht)) +
  geom_col(width = 1) +
  scale_y_continuous(name = "Percentage", labels = scales::percent_format()) +
  scale_x_continuous(name = "Time (rounded to the nearest hour)") +
  facet_wrap(~tiercollar ) +
  theme_light() +
   theme(legend.position="bottom")
p_1stO_1_before_Sabi_Olga



Sabi_Olga_smry_after <- Sabi_Olga_1stO_2d_after %>%
  st_set_geometry(NULL) %>%
  mutate(
    hour = hour(round_date(DatetimeUTC,"hour")),
    Frucht = ifelse(is.na(Frucht),"other",Frucht),
    Frucht = fct_lump(Frucht, 5,other_level = "other"),
  ) %>%
  group_by(tiercollar ,hour,Frucht) %>%
  count() %>%
  ungroup() %>%
  group_by(tiercollar , hour) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    Frucht = fct_reorder(Frucht, n,sum, desc = TRUE)
  )

p_1stO_1_after_Sabi_Olga <- ggplot(Sabi_Olga_smry_after, aes(hour,perc, fill = Frucht)) +
  geom_col(width = 1) +
  scale_y_continuous(name = "Percentage", labels = scales::percent_format()) +
  scale_x_continuous(name = "Time (rounded to the nearest hour)") +
  facet_wrap(~tiercollar ) +
  theme_light() +
   theme(legend.position="bottom")
p_1stO_1_after_Sabi_Olga

```


